{"version":3,"sources":["../../src/sls/index.js"],"names":["util","$","API","require","LEN","defaultConfig","accessId","accessKey","endpoint","timeout","signature_method","api_version","logger","SClient","config","Util","checkDefault","mt","uri","hd","bd","fn","toUpperCase","getDate","sortStr","getSortParamStr","signature","signFn","url","encodeURIComponent","rEp","getRealEndPoint","vurl","host","httpReq","protobuf","err","data","statusCode","headers","info","limitLen","JSON","stringify","length","parse","e","kk","prototype","obj","flag","t","k","APIVersion","push","sort","join","v","parseURL","p","hostname","isIP","protocol","pathname","replace","s","test"],"mappings":"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","file":"index.js","sourcesContent":["\"use strict\";\n\n//var util = require('./util');\nimport util from './util';\nvar API = require('./api'); \n//import API from './api';\nvar LEN = 500;\nimport $ from 'jquery';\n\n\nvar defaultConfig = {\n\n    //requires\n    accessId: '',                  //accessId\n    accessKey: '',                 //accessKey\n    endpoint: '',            //sls service endpoint\n\n    //optional\n    timeout: 20000,         //请求timeout时间, 默认: 20s\n\n    signature_method: 'hmac-sha1', //签名计算方式，目前只支持'hmac-sha1', 默认: 'hmac-sha1'\n    api_version: '0.3.0',  //数据相关api version 默认 0.3.0\n\n    logger: false   //打印请求的详细信息, log4js 实例\n};\n\n\n/**\n * 服务端\n */\nexport class SClient{\n   constructor (config) {\n\n     Util.checkDefault(config, defaultConfig);\n     this.config = config;\n   }\n   requestData (mt, uri, hd, bd, fn, timeout) {\n        var config = this.config;\n\n        mt = mt.toUpperCase();\n\n        bd = bd || {};\n        bd['x-date'] = Util.getDate();\n        bd['APIVersion'] = config.api_version || '0.3.0';\n        bd['AccessKeyId'] = config.accessId;\n        bd['SignatureMethod'] = config.signature_method;\n        hd['User-Agent']=\"slsweb\";\n\n\n        var sortStr = getSortParamStr(bd);\n\n        var signature = Util.signFn(config.accessKey, uri + '\\n' + sortStr);\n\n        var url = uri + '?' + getSortParamStr(bd, true) + '&Signature=' + encodeURIComponent(signature);\n        var logger = config.logger;\n\n        var rEp = getRealEndPoint(config.endpoint, bd);\n\n        var vurl = rEp.endpoint + url;\n\n        hd['host'] = rEp.host;\n\n        //console.log('SLS_CLIENT_CALL: method:', mt, ', url:', vurl, ', headers:', hd, ', body:', bd.protobuf||null );\n\n        Util.httpReq(mt, vurl, hd, bd.protobuf || null, function (err, data, statusCode, headers) {\n\n            if (logger) {\n                logger.info('SLS_CLIENT_CALL: method:', mt, ', url:', vurl, ', headers:', hd, ', body:', Util.limitLen(bd, LEN),\n                    '---------RESPONSE---------\\n err:', err, ', data:', Util.limitLen(data, LEN), ', contentLength:'+(JSON.stringify(data).length)+', status:', statusCode, ', headers:', headers);\n            }\n            if (typeof(data) == 'string') {\n                try {\n                    data = JSON.parse(data);\n                } catch (e) {\n                }\n            }\n\n            if(statusCode<400){\n              fn(err, data, statusCode, headers);\n            }else{\n              fn(err||data, data, statusCode, headers);\n            }\n\n        }, timeout || config.timeout);\n    };\n\n};\n\n//业务逻辑\nfor (var kk in API) {\n    SClient.prototype[kk] = API[kk];\n}\n;\n\n\nvar getSortParamStr = function (obj, flag) {\n    var t = [];\n    if (flag) {\n        for (var k in obj) {\n            if (k=='protobuf'|| obj.APIVersion >= '0.3.0' && k == 'Project')continue;\n            t.push(k + '=' + encodeURIComponent(obj[k]));\n        }\n    }\n    else {\n        for (var k in obj) {\n            if (k=='protobuf' || obj.APIVersion >= '0.3.0' && k == 'Project')continue;\n            t.push(k + '=' + obj[k]);\n        }\n    }\n    t.sort();\n    return t.join('&');\n};\n\n\nvar getRealEndPoint = function(url, obj){\n\n     //test\n    //return {endpoint:  'http://service.sls-stg.aliyun-inc.com:179/', host: '44.sls-stg.aliyun-inc.com:179'};\n\n    var v = Util.parseURL(url);\n    var p = obj['Project'];\n\n    if( obj.APIVersion>='0.3.0'){\n\n        var host = p+'.'+ v.hostname;\n\n        if(isIP(v.hostname)){\n            url = v.protocol+ '//'+ v.host + v.pathname;\n        }else{\n            url = v.protocol+ '//'+ p+'.'+ v.host + v.pathname;\n        }\n\n        return {\n            endpoint: url.replace(/\\/$/g,''),\n            host: host\n        };\n    }else{\n        return {endpoint: url.replace(/\\/$/g,''), host: v.hostname};\n    }\n};\n\nvar isIP = function(s){\n    return /^[\\d.]+$/.test(s);\n};\n"]}